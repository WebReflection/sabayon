let{SharedArrayBuffer:e}=globalThis,t=!0;try{new e(4,{maxByteLength:8})}catch(s){t=!1,e=class extends ArrayBuffer{get growable(){return super.resizable}grow(e){super.resize(e)}}}let{parse:s,rawJSON:r}=JSON;if(!r){const{freeze:e,setPrototypeOf:t}=Object;class a{static isRawJSON(e){return"object"==typeof e&&!!e&&#e in e}#e=!0;constructor(s){this.rawJSON=s,e(t(this,null))}}r=e=>{const t=typeof e;switch(t){case"object":if(e)break;case"bigint":case"boolean":case"number":e=String(e);case"string":return s(e),new a(e)}throw new TypeError("Unexpected "+t)};const n=s;s=(e,t)=>{if("function"==typeof t){const s=t,r=[];e=String(e).replace(/(?:"(?:(?=(\\?))\1.)*?"\s*:?|[0-9eE+.-]+|true|false|null)/g,(e=>":"!==e.at(-1)?'"'===e[0]?r.push(e)-1:`"${e}"`:e)),t=function(e,t){switch(typeof t){case"number":t=r[t];case"string":return s.call(this,e,n(t),{source:t})}return s.call(this,e,t,{})}}return n(e,t)}}const a=(e,t,s)=>"number"==typeof t&&String(t)!==s?.source?BigInt(s.source):t;var n=Promise.withResolvers.bind(Promise);const{ArrayBuffer:o,Atomics:c,Promise:i}=globalThis,{isArray:l}=Array,{create:u,getPrototypeOf:p,values:f}=Object,g=p(Int32Array),w=u(c),y=({currentTarget:e,type:t,origin:s,lastEventId:r,source:a,ports:n},o)=>e.dispatchEvent(new MessageEvent(t,{data:o,origin:s,lastEventId:r,source:a,ports:n}));let d=0;const h=new Map,b=(e,t)=>class extends e{constructor(e,...s){super(e,...s),e instanceof t&&h.set(this,[d++,0,n()])}},v=new WeakSet,m=e=>(v.add(e),e),A=e=>null!==e&&"object"==typeof e&&!v.has(e),S=new WeakMap,k=(e,t,s)=>{if(h.has(e))t.set(e,h.get(e)[0]);else if(!(e instanceof g||e instanceof o))for(const r of f(e))A(r)&&!s.has(r)&&(s.add(r),k(r,t,s))};let T=0;const E=(...e)=>({value:new i((async t=>{const s="/__sabayon_wait_async.js";if(!T){const e=fetch(s,{method:"HEAD"}).then((e=>e.ok),(()=>!1));T=await e?1:-1}const r=new Worker(T<0?"data:application/javascript,onmessage%3De%3D%3EpostMessage(!Atomics.wait(...e.data))":s);r.onmessage=()=>{r.terminate(),t("ok")},r.postMessage(e)}))}),O=(e,t)=>{const s=h.get(e),[r,a,{promise:n}]=s;return s[1]=t,[r,n]};let{BigInt64Array:I,Int32Array:j,SharedArrayBuffer:M,addEventListener:x,postMessage:B}=globalThis,P=!0,J=e=>e,N=!t;const $=n();if(t)w.waitAsync||(w.waitAsync=E),$.resolve();else{const t=B,r=x,n=[];let o="",c="";M=e,I=b(I,M),j=b(j,M),J=m,w.notify=(e,s)=>{const[r]=(e=>S.get(e))(e);return t([o,1,e,r,s]),0},w.waitAsync=(...e)=>{const[t,s]=O(...e);return{value:s}},w.wait=(e,t,...r)=>{const[n]=O(e,t,...r),i=new XMLHttpRequest;i.open("POST",`${c}?sabayon`,!1),i.setRequestHeader("Content-Type","application/json"),i.send(`["${o}",${n},${t}]`),h.delete(e);const l=e instanceof I?s(i.responseText,a):s(i.responseText);return e.set(l),"ok"},r("message",(e=>{if(((e,t)=>{const{data:s}=e,r=l(s)&&(s.at(0)===t||0===s.at(1)&&!t);return r&&(e.stopImmediatePropagation(),e.preventDefault()),r})(e,o)){const[t,s,...r]=e.data;switch(s){case 0:o=t,c=r.at(0)?.serviceWorker||"",c||(w.wait=null,$.resolve());break;case 1:((e,t,s)=>{for(const[r,[a,n,{resolve:o}]]of h)if(t===a&&s===n){r.set(e),h.delete(r),o("ok");break}})(...r);break;case 2:((e,t,s)=>{for(const[s,r]of t)S.set(s,[r,e.currentTarget]);y(e,s)})(e,...r);break;case 3:$.resolve()}}else if(P){const{currentTarget:t,type:s,origin:r,lastEventId:a,source:o,ports:c}=e;n.push([{currentTarget:t,type:s,origin:r,lastEventId:a,source:o,ports:c},e.data])}})),x=(e,...t)=>{if(r(e,...t),n.length)for(const e of n.splice(0))y(...e)},B=(e,...s)=>t(((e,t)=>{const s=new Map;return A(t)&&k(t,s,new Set),s.size?[e,2,s,t]:t})(o,e),...s)}await $.promise,P=!1;export{w as Atomics,I as BigInt64Array,j as Int32Array,M as SharedArrayBuffer,x as addEventListener,J as ignore,N as polyfill,B as postMessage};
