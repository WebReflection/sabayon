var e=Promise.withResolvers.bind(Promise);let{SharedArrayBuffer:t}=globalThis,s=!0;try{new t(4,{maxByteLength:8})}catch(e){s=!1,t=class extends ArrayBuffer{get growable(){return super.resizable}grow(e){super.resize(e)}}}const{isArray:o}=Array,{isView:r}=ArrayBuffer,{defineProperty:a,values:n}=Object;let i=()=>{};if(!s){globalThis.SharedArrayBuffer=t;const[s,l]=((t=e=>e)=>{const s=new Map;let o=0;return[()=>{let r;do{r=t(o++)}while(s.has(r));const a=e();return s.set(r,a),[r,a.promise]},(e,t,o)=>{const r=s.get(e);s.delete(e),o?r?.reject(o):r?.resolve(t)}]})(),c=new Map,f=(e,...t)=>{e.addEventListener(...t)};if("importScripts"in globalThis){const a=function(e,t){for(let s=0;s<t.length;s++){const o=g(e,t[s]);if(o)return o}},g=function(e,s){if(s&&"object"==typeof s&&!e.has(s)){if(e.add(s),!r(s))return a(e,o(s)?s:n(s));if(s instanceof Int32Array&&s.buffer instanceof t){const e=B++;return c.set(s,e),[T,e,s]}}},h=e=>function(t,...s){if(x){const o=g(new Set,t);e.call(this,o?[...o,t]:t,...s)}else u.then((()=>postMessage(t,...s)))};globalThis.postMessage=h(globalThis.postMessage);const{prototype:d}=globalThis.MessagePort;d.postMessage=h(d.postMessage);let[p,u]=s();f(self,"message",(e=>{e.stopImmediatePropagation(),l(p,e.data)}),{once:!0});let{wait:y,waitAsync:w}=Atomics;const{parse:b,stringify:m}=JSON,v=e=>({value:e,async:!0}),A=(e,t)=>{const s=new XMLHttpRequest;return s.open("POST",`${S}?sabayon`,t),s.send(m([T,c.get(e)])),s},M=(e,t)=>(e.set(b(t.responseText)),c.delete(e),"ok");Atomics.wait=(e,...t)=>c.has(e)?M(e,A(e,!1)):y(e,...t),Atomics.waitAsync=(t,...s)=>{if(c.has(t)){const{promise:s,resolve:o}=e(),r=A(t,!0);return r.onloadend=()=>o(M(t,r)),v(s)}return w?w(t,...s):v(import("./wait-async-DamqqYKQ.js").then((({default:e})=>e(k,t,...s))))};let T,S,k,x=!1,B=Math.random();u=u.then((e=>{[T,S,k]=e,x=!0})),i=()=>u}else{const t=crypto.randomUUID(),r=new BroadcastChannel("dd78209b-186c-4f83-80e9-406becb7d9f3");r.onmessage=async e=>{const[s,o,a]=e.data;if(o===t)for(const[e,[t,o]]of c)if(t===a){await o.promise,c.delete(e);let t=e.length;for(;t--&&!e[t];);r.postMessage([s,e.slice(0,t+1)]);break}};const n=s=>{let{data:r}=s;if(o(r)&&r.at(0)===t){const[t,o,n,i]=r;c.set(n,[o,e()]),a(s,"data",{value:i})}};globalThis.MessageChannel=class extends globalThis.MessageChannel{constructor(){super(),f(this.port1,"message",n),f(this.port2,"message",n)}},globalThis.Worker=class extends globalThis.Worker{constructor(e,s){if(!h)throw new Error("ServiceWorker not registered");super(e,s).postMessage([t,h,d]),f(this,"message",n)}};const{notify:g}=Atomics;Atomics.notify=(e,...t)=>{const s=c.get(e);return s?(s[1].resolve(),0):g(e,...t)};let h="",d="",p=null;const u=({serviceWorker:e},t)=>{let s,o=!0;e.getRegistration(h).then((t=>t??e.register(h))).then((function r(a){o=o&&!!e.controller,s=a.installing||a.waiting||a.active,"activated"===s.state?o?l(t):location.reload():f(s,"statechange",(()=>r(a)),{once:!0})}))};i=(e,t="/__sabayon_wait_async.js")=>{if(!p){const{href:o}=location;h=new URL(e,o).href,d=new URL(t,o).href;const[r,a]=s();u(navigator,r),p=a}return p}}}var l=i;export{l as default};
