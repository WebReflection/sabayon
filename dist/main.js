var e=Promise.withResolvers.bind(Promise);const{ArrayBuffer:t,Atomics:s,Promise:a}=globalThis,{isArray:r}=Array,{create:o,getPrototypeOf:n,values:c}=Object,i=n(Int32Array),l=o(s);let p=0;const g=new Map,f=(t,s)=>class extends t{constructor(t,...a){super(t,...a),t instanceof s&&g.set(this,[p++,0,e()])}},d=new WeakSet,u=e=>(d.add(e),e),h=(e,t)=>{const{data:s}=e,a=r(s)&&(s.at(0)===t||0===s.at(1)&&!t);return a&&(e.stopImmediatePropagation(),e.preventDefault()),a},v=e=>null!==e&&"object"==typeof e&&!d.has(e),y=new WeakMap,w=(e,s,a)=>{if(g.has(e))s.set(e,g.get(e)[0]);else if(!(e instanceof i||e instanceof t))for(const t of c(e))v(t)&&!a.has(t)&&(a.add(t),w(t,s,a))};let m=0;const A=(...e)=>({value:new a((async t=>{const s="/__sabayon_wait_async.js";if(!m){const e=fetch(s,{method:"HEAD"}).then((e=>e.ok),(()=>!1));m=await e?1:-1}const a=new Worker(m<0?"data:application/javascript,onmessage%3De%3D%3EpostMessage(!Atomics.wait(...e.data))":s);a.onmessage=()=>{a.terminate(),t("ok")},a.postMessage(e)}))}),k=(e,t,s)=>{for(const[s,a]of t)y.set(s,[a,e.currentTarget]);(({currentTarget:e,type:t,origin:s,lastEventId:a,source:r,ports:o},n)=>{e.dispatchEvent(new MessageEvent(t,{data:n,origin:s,lastEventId:a,source:r,ports:o}))})(e,s)};let{BigInt64Array:M,Int32Array:b,SharedArrayBuffer:I,Worker:W}=globalThis,E=e=>e,j=!1;const x=e=>({...e,type:"module"});try{new I(4),W=class extends W{constructor(e,t){super(e,x(t))}},l.waitAsync||(l.waitAsync=A)}catch(s){const a=crypto.randomUUID(),r=new Map,o=(e,t,s,...a)=>{e.addEventListener(t,s,...a)},n=({serviceWorker:t},s,n)=>{let c,i=!0;o(t,"message",(t=>{if(h(t,a)){const[s,o,n]=t.data,i=[o,n].join(","),l=e=>{r.delete(i),c.postMessage([a,o,n,e])},p=r.get(i);if(p)l(p);else{const{promise:t,resolve:s}=e();r.set(i,s),t.then(l)}}})),t.getRegistration(s).then((e=>e??t.register(s))).then((function e(s){i=i&&!!t.controller,c=s.installing||s.waiting||s.active,"activated"===c.state?i?n():location.reload():o(c,"statechange",(()=>e(s)),{once:!0})}))};E=u,j=!0,l.notify=(e,t)=>{const[s,o]=(e=>y.get(e))(e),n=[s,t].join(","),c=r.get(n);return c?c(e):r.set(n,e),o.postMessage([a,1,e,s,t]),0},l.waitAsync=(e,...t)=>{const[s,a]=((e,t)=>{const s=g.get(e),[a,r,{promise:o}]=s;return s[1]=t,[a,o]})(e,...t);return{value:a}},I=class extends t{},M=f(M,I),b=f(b,I);let c=null;W=class extends W{constructor(t,s){let r=s?.serviceWorker||"";if(r){if(r=new URL(r,location.href).href,s={...s,serviceWorker:r},!c){const{promise:t,resolve:s}=e();n(navigator,r,s),c=t}c.then((()=>super.postMessage([a,3])))}super(t,x(s)),super.postMessage([a,0,s]),o(this,"message",(e=>{if(h(e,a)){const[t,s,...a]=e.data;switch(s){case 1:((e,t,s)=>{for(const[a,[r,o,{resolve:n}]]of g)if(t===r&&s===o){a.set(e),g.delete(a),n("ok");break}})(...a);break;case 2:k(e,...a)}}}))}postMessage(e,...t){return super.postMessage(((e,t)=>{const s=new Map;return v(t)&&w(t,s,new Set),s.size?[e,2,s,t]:t})(a,e),...t)}}}export{l as Atomics,M as BigInt64Array,b as Int32Array,I as SharedArrayBuffer,W as Worker,E as ignore,j as polyfill};
